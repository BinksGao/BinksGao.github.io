<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>了解Nginx | Binks の Blog</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/images/favicon.ico">
    <meta name="description" content="Binks の Blog">
    <link rel="preload" href="/assets/css/0.styles.5278ec6f.css" as="style"><link rel="preload" href="/assets/js/app.79c4ef9b.js" as="script"><link rel="preload" href="/assets/js/2.62e03d70.js" as="script"><link rel="preload" href="/assets/js/4.34866f2f.js" as="script"><link rel="prefetch" href="/assets/js/10.2b9ec67f.js"><link rel="prefetch" href="/assets/js/11.97b90e53.js"><link rel="prefetch" href="/assets/js/12.92e99fae.js"><link rel="prefetch" href="/assets/js/13.d6010d2b.js"><link rel="prefetch" href="/assets/js/14.2bd827e2.js"><link rel="prefetch" href="/assets/js/15.a4bed71d.js"><link rel="prefetch" href="/assets/js/16.0a4c23bf.js"><link rel="prefetch" href="/assets/js/17.990b8886.js"><link rel="prefetch" href="/assets/js/18.10eb592c.js"><link rel="prefetch" href="/assets/js/19.a857fa1d.js"><link rel="prefetch" href="/assets/js/20.bf3a85a3.js"><link rel="prefetch" href="/assets/js/21.eb0b8747.js"><link rel="prefetch" href="/assets/js/22.163a2ab8.js"><link rel="prefetch" href="/assets/js/23.c9bb7e11.js"><link rel="prefetch" href="/assets/js/24.7baf5745.js"><link rel="prefetch" href="/assets/js/25.22305377.js"><link rel="prefetch" href="/assets/js/26.1f9a22f1.js"><link rel="prefetch" href="/assets/js/27.3f4612a4.js"><link rel="prefetch" href="/assets/js/28.d627a50b.js"><link rel="prefetch" href="/assets/js/29.acd9ae0a.js"><link rel="prefetch" href="/assets/js/3.f32212ed.js"><link rel="prefetch" href="/assets/js/30.16430b08.js"><link rel="prefetch" href="/assets/js/31.cb714c34.js"><link rel="prefetch" href="/assets/js/32.d4266de2.js"><link rel="prefetch" href="/assets/js/33.985bba62.js"><link rel="prefetch" href="/assets/js/5.d8740383.js"><link rel="prefetch" href="/assets/js/6.fc12b4c6.js"><link rel="prefetch" href="/assets/js/7.e3565c63.js"><link rel="prefetch" href="/assets/js/8.02f836d8.js"><link rel="prefetch" href="/assets/js/9.8b0a1d5b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5278ec6f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Binks の Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博文" class="dropdown-title"><span class="title">博文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">
  前端篇
</a></li><li class="dropdown-item"><!----> <a href="/backstage/" class="nav-link router-link-active">
  后端篇
</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/BinksGao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博文" class="dropdown-title"><span class="title">博文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">
  前端篇
</a></li><li class="dropdown-item"><!----> <a href="/backstage/" class="nav-link router-link-active">
  后端篇
</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/BinksGao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">首页</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>后端篇</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Mysql</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Nginx</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/backstage/Nginx/nginx.html" class="active sidebar-link">了解nginx</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backstage/Nginx/nginx.html#了解nginx" class="sidebar-link">了解Nginx</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backstage/Nginx/nginx.html#什么是nginx" class="sidebar-link">什么是nginx</a></li><li class="sidebar-sub-header"><a href="/backstage/Nginx/nginx.html#反向代理服务器" class="sidebar-link">反向代理服务器</a></li><li class="sidebar-sub-header"><a href="/backstage/Nginx/nginx.html#虚拟主机" class="sidebar-link">虚拟主机</a></li></ul></li></ul></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="了解nginx"><a href="#了解nginx" class="header-anchor">#</a> 了解Nginx</h2> <h3 id="什么是nginx"><a href="#什么是nginx" class="header-anchor">#</a> 什么是nginx</h3> <p>Nginx是一款轻量级的Web服务器、反向代理服务器，由于它的内存占用少（一个worker进程只占用10-12M内存），启动极快，高并发能力强，在互联网项目中广泛应用。</p> <h3 id="反向代理服务器"><a href="#反向代理服务器" class="header-anchor">#</a> 反向代理服务器</h3> <h4 id="正向代理"><a href="#正向代理" class="header-anchor">#</a> 正向代理</h4> <p>由于防火墙的原因，我们并不能直接访问谷歌，那么我们可以借助VPN来实现，这就是一个简单的正向代理的例子。这里你能够发现，正向代理“代理”的是客户端，而且客户端是知道目标的，而目标是不知道客户端是通过VPN访问的</p> <h4 id="反向代理"><a href="#反向代理" class="header-anchor">#</a> 反向代理</h4> <p>当我们在外网访问百度的时候，其实会进行一个转发，代理到内网去，这就是所谓的反向代理，即反向代理“代理”的是服务器端，而且这一个过程对于客户端而言是透明的</p> <h5 id="nginx的master-worker模式"><a href="#nginx的master-worker模式" class="header-anchor">#</a> Nginx的Master-Worker模式</h5> <p>要启动nginx，只需要输入命nginx，其中xxx是你nginx的安装目录。</p> <p><img src="/assets/img/18.9cabd391.jpeg" alt="avatar"></p> <p>启动Nginx后，其实就是在80端口启动了Socket服务进行监听。<br></p> <p><img src="/assets/img/19.7d1dc679.jpeg" alt="avatar"></p> <p>Master进程的作用：读取并验证配置文件nginx.conf；管理worker进程；<br>
Worker进程的作用：每一个Worker进程都维护一个线程（避免线程切换），处理连接和请求；注意Worker进程的个数由配置文件决定，一般和CPU个数相关（有利于进程切换），配置几个就有几个Worker进程，上面的例子只有1个Worker进程。</p> <h4 id="思考1：nginx如何做到热部署？"><a href="#思考1：nginx如何做到热部署？" class="header-anchor">#</a> 思考1：Nginx如何做到热部署？</h4> <p>所谓热部署，就是配置文件nginx.conf修改后，不需要stop Nginx，不需要中断请求，就能让配置文件生效！（nginx -s reload 重新加载/nginx -t检查配置/nginx -s stop）</p> <p>通过上文我们已经知道worker进程负责处理具体的请求，那么如果想达到热部署的效果，可以想象：</p> <p>方案一：修改配置文件nginx.conf后，主进程master负责推送给worker进程更新配置信息，worker进程收到信息后，更新进程内部的线程信息。</p> <p>方案二：修改配置文件nginx.conf后，重新生成新的worker进程，当然会以新的配置进行处理，而且新的请求都必须交给新的worker进程，至于老worker进程，等把那些以前的请求处理完毕，kill掉即可。</p> <p>Nginx采用的就是方案二来达到热部署的！</p> <h4 id="思考2：nginx如何做到高并发下的高效处理？"><a href="#思考2：nginx如何做到高并发下的高效处理？" class="header-anchor">#</a> 思考2：Nginx如何做到高并发下的高效处理？</h4> <p>上文已经提及Nginx的worker进程个数与CPU绑定、worker进程内部包含一个线程高效回环处理请求，这的确有助于效率，但这是不够的。</p> <p>作为专业的程序员，我们可以开一下脑洞：BIO/NIO/AIO、异步/同步、阻塞/非阻塞...</p> <p>要同时处理那么多的请求，要知道，有的请求需要发生IO，可能需要很长时间，如果等着它，就会拖慢worker的处理速度。</p> <p>Nginx采用了Linux的epoll模型，epoll模型基于事件驱动机制，它可以监控多个事件是否准备完毕，如果OK，那么放入epoll队列中，这个过程是异步的。worker只需要从epoll队列循环处理即可。</p> <h4 id="思考3：nginx挂了怎么办？"><a href="#思考3：nginx挂了怎么办？" class="header-anchor">#</a> 思考3：Nginx挂了怎么办？</h4> <p>Nginx既然作为入口网关，很重要，如果出现单点问题，显然是不可接受的。答案是：Keepalived+Nginx实现高可用。</p> <p>Keepalived是一个高可用解决方案，主要是用来防止服务器单点发生故障，可以通过和Nginx配合来实现Web服务的高可用。（其实，Keepalived不仅仅可以和Nginx配合，还可以和很多其他服务配合）</p> <p>Keepalived+Nginx实现高可用的思路：</p> <p>第一：请求不要直接打到Nginx上，应该先通过Keepalived（这就是所谓虚拟IP，VIP）</p> <p>第二：Keepalived应该能监控Nginx的生命状态（提供一个用户自定义的脚本，定期检查Nginx进程状态，进行权重变化,，从而实现Nginx故障切换）</p> <h4 id="keepalived-nginx"><a href="#keepalived-nginx" class="header-anchor">#</a> Keepalived+Nginx</h4> <p>我们的主战场：nginx.conf</p> <p>很多时候，在开发、测试环境下，我们都得自己去配置Nginx，就是去配置nginx.conf。nginx.conf是典型的分段配置文件，下面我们来分析下。在 Nginx 内部，你可以指定多个虚拟服务器，每个虚拟服务器用 server{} 上下文描述。</p> <h3 id="虚拟主机"><a href="#虚拟主机" class="header-anchor">#</a> 虚拟主机</h3> <p>nginx的配置文件主要由指令构成，指令主要包括名称和参数，以分号;结束。如下是一个虚拟服务器的配置：listen 指令来指定该虚拟主机在监听给定的 IP 端口组合；server_name指令检测 Host 头以决定请求到底匹配到哪个虚拟主机...nginx的配置项很多，具体可以查阅网上资料。</p> <p><img src="/assets/img/20.5615e00c.jpeg" alt="avatar"></p> <p>其实这是把Nginx作为web server来处理静态资源，</p> <p>1：location可以进行正则匹配，应该注意正则的几种形式以及优先级。（这里不展开）</p> <p>2：Nginx能够提高速度的其中一个特性就是：动静分离，就是把静态资源放到Nginx上，由Nginx管理，动态请求转发给后端。</p> <p>3：我们可以在Nginx下把静态资源、日志文件归属到不同域名下（也即是目录），这样方便管理维护。</p> <p>4：Nginx可以进行IP访问控制，有些电商平台，就可以在Nginx这一层，做一下处理，内置一个黑名单模块，那么就不必等请求通过Nginx达到后端在进行拦截，而是直接在Nginx这一层就处理掉。</p> <h4 id="反向代理-proxy-pass"><a href="#反向代理-proxy-pass" class="header-anchor">#</a> 反向代理---proxy_pass</h4> <p>所谓反向代理，很简单，其实就是在location这一段配置中的root替换成proxy_pass即可。root说明是静态资源，可以由Nginx进行返回;而proxy_pass说明是动态请求，需要进行转发，比如代理到Tomcat上。</p> <p>反向代理，上面已经说了，过程是透明的，比如说request -&gt; Nginx -&gt; Tomcat，那么对于Tomcat而言，请求的IP地址就是Nginx的地址，而非真实的request地址，这一点需要注意。不过好在Nginx不仅仅可以反向代理请求，还可以由用户自定义设置HTTP HEADER。</p> <h4 id="负载均衡-upstream"><a href="#负载均衡-upstream" class="header-anchor">#</a> 负载均衡---upstream</h4> <p>上面的反向代理中，我们通过proxy_pass来指定Tomcat的地址，很显然我们只能指定一台Tomcat地址，那么我们如果想指定多台来达到负载均衡呢？</p> <p>1：通过upstream来定义一组Tomcat，并指定负载策略（IPHASH、加权论调、最少连接），健康检查策略（Nginx可以监控这一组Tomcat的状态）等。</p> <p>2：将proxy_pass替换成upstream指定的值即可。</p> <p>负载均衡需要注意的问题：选择不同的负载均衡算法，可能会带来不同的问题，如果选择轮询方式，那么一个请求，可以到A server，也可以到B server，我们得注意用户状态的保存问题，如Session会话信息，不能在保存到服务器上。</p> <p>如果选择散列，没有了上面的问题，但是又得考虑，什么样的散列算法尽可能均匀打到后端的服务器上，总之实际应用中需要根据场景权衡选择。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/backstage/Mysql/one.html" class="prev">
        第一篇
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.79c4ef9b.js" defer></script><script src="/assets/js/2.62e03d70.js" defer></script><script src="/assets/js/4.34866f2f.js" defer></script>
  </body>
</html>
